# Compile from Git
# Needs: swig automake libtool tcl86

VERSION="HEAD"
CC="gcc"

if [ -d "/usr/local/Cellar" ]; then
	# Homebrew in OS X has a Cellar directory
	PREFIX="/usr/local/Cellar/xapian/$VERSION"
else
	PREFIX="/usr/local"
fi

if [ ! -d xapian ]; then
	git clone https://github.com/xapian/xapian.git
fi


# Build xapian-core
######################################
cd xapian/xapian-core
# Autoconf, configure and make:
./preautoreconf
autoreconf --force --install -Im4 -I/usr/local/share/aclocal
./configure --enable-maintainer-mode --disable-documentation --disable-dependency-tracking --prefix="$PREFIX"
make
make install
cd ../..


# Build Python xapian-bindings
######################################
cd xapian/xapian-bindings

cd python
# Generate except.i
perl -w -I../../xapian-core generate-python-exceptions

# Generate version.i
sed "s/@VERSION@/$VERSION/" version.i.in > version.i

# Create empty doccomments.i (no documentation was ever built to properly generate it)
touch doccomments.i

# Build bindings
swig -I../../xapian-core/include -c++ -python -threads -shadow -modern -O -o xapian_wrap.cc python.i

cd ../..

# Autoconf, configure and make:
autoreconf --force --install -Im4 -I/usr/local/share/aclocal
./configure --disable-dependency-tracking --prefix="$PREFIX" PYTHON_LIB="$PREFIX/lib/python2.7/site-packages" XAPIAN_CONFIG=$PREFIX/bin/xapian-config-1.3 --without-csharp --without-tcl --without-java --without-ruby --with-python --without-php
make
make install
cd ..


# Running tests
######################################
cd xapian-core
make check
cd ..
