# Compile Xapian from Git
# Needs: automake libtool tcl86


# Get repository from GitHub
######################################
if [ ! -d "xapian" ]; then
	git clone -b RELEASE/1.4 --single-branch --depth 1 "https://github.com/xapian/xapian.git"
fi


# Configure environment
######################################

if [ -d "/usr/local/Cellar" ]; then
	# Homebrew in OS X has a Cellar directory
	PREFIX="/usr/local/Cellar/xapian/HEAD"
else
	PREFIX="/usr/local"
fi


# Build xapian-core
######################################
cd xapian/xapian-core
# Autoconf, configure and make:
./preautoreconf
autoreconf --force --install -Im4 -I/usr/local/share/aclocal
./configure CXXFLAGS="-DFLINTLOCK_USE_FLOCK $CXXFLAGS" --enable-maintainer-mode --disable-documentation --disable-dependency-tracking --prefix="$PREFIX"
make
make check
make install
cd ../..


# Building sanitized libraries
######################################
# ./configure CXXFLAGS="-DFLINTLOCK_USE_FLOCK $CXXFLAGS" LDFLAGS=" $LDFLAGS" --enable-maintainer-mode --disable-documentation --disable-dependency-tracking --prefix="/usr/local/Cellar/xapian/HEAD" && make clean && make install
# ./configure CXXFLAGS="-DFLINTLOCK_USE_FLOCK -fsanitize=address -fno-omit-frame-pointer $CXXFLAGS" LDFLAGS="-fsanitize=address -fno-omit-frame-pointer $LDFLAGS" --enable-maintainer-mode --disable-documentation --disable-dependency-tracking --prefix="/usr/local/Cellar/xapian/ASAN" && make clean && make install
# ./configure CXXFLAGS="-DFLINTLOCK_USE_FLOCK -fsanitize=thread $CXXFLAGS" LDFLAGS="-fsanitize=thread $LDFLAGS" --enable-maintainer-mode --disable-documentation --disable-dependency-tracking --prefix="/usr/local/Cellar/xapian/TSAN" && make clean && make install
# ./configure CXXFLAGS="-DFLINTLOCK_USE_FLOCK -fsanitize=memory -fsanitize-memory-track-origins -fno-omit-frame-pointer $CXXFLAGS" LDFLAGS="-fsanitize=memory -fsanitize-memory-track-origins -fno-omit-frame-pointer $LDFLAGS" --enable-maintainer-mode --disable-documentation --disable-dependency-tracking --prefix="/usr/local/Cellar/xapian/MSAN" && make clean && make install
# ./configure CXXFLAGS="-DFLINTLOCK_USE_FLOCK -fsanitize=undefined -fno-omit-frame-pointer $CXXFLAGS" LDFLAGS="-fsanitize=undefined -fno-omit-frame-pointer $LDFLAGS" --enable-maintainer-mode --disable-documentation --disable-dependency-tracking --prefix="/usr/local/Cellar/xapian/UBSAN" && make clean && make install

# Then use (for ASAN, for example):
######################################
# mkdir asan-build && cd asan-build
# brew switch xapian ASAN
# cmake -GNinja -DCMAKE_FIND_FRAMEWORK=LAST -DCMAKE_BUILD_TYPE=Debug -DASAN=ON .. && ninja -j3
